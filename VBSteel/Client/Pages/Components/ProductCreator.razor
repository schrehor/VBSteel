@using VBSteel.Shared
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http.Headers
@using System.Linq.Expressions
@inject AuthorizedHttpClient AuthorizedHttpClient

@if (success)
{
	<div class="alert alert-success" role="alert">
		Produkt bol vytvorený.
	</div>
}
<EditForm Model="@_newProduct" OnValidSubmit="@HandleValidSubmit">
	<DataAnnotationsValidator />
	<ValidationSummary />

	<InputText id="name" @bind-Value="_newProduct.Name" placeholder="Product Name" />
	<InputText id="description" @bind-Value="_newProduct.Description" placeholder="Product Description" />
	<InputFile id="image" OnChange="@HandleFileSelected" />

	<button type="submit">Create</button>
</EditForm>

@code {
	private ProductInputModel _newProduct = new();
	private bool success = false;

	private async Task HandleValidSubmit()
	{
		try
		{
			var response = await AuthorizedHttpClient.PostAsJsonAsync("api/Product/CreateProduct", _newProduct);
			if (response.IsSuccessStatusCode)
			{
				success = true;
			}
			else
			{
				var error = await response.Content.ReadAsStringAsync();
				Console.WriteLine($"Error: {error}");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Exception: {ex.Message}");
		}
	}

	private async void HandleFileSelected(InputFileChangeEventArgs e)
	{
		var selectedFile = e.File;
		var memoryStream = new MemoryStream();
		await selectedFile.OpenReadStream().CopyToAsync(memoryStream);
		_newProduct.ImageData = memoryStream.ToArray();
		_newProduct.ImageType = selectedFile.ContentType.Split('/')[1];
	}
}